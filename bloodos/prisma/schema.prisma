
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ================================
// Core Enums
// ================================

enum UserRole {
  DONOR
  HOSPITAL
  ADMIN
  NGO
}

enum BloodType {
  A_POS
  A_NEG
  B_POS
  B_NEG
  AB_POS
  AB_NEG
  O_POS
  O_NEG
}

enum RequestStatus {
  PENDING
  APPROVED
  FULFILLED
  REJECTED
  CANCELLED
}

enum UrgencyLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum DonationStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
}

// ================================
// Models
// ================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String // Hashed password
  role      UserRole @default(DONOR)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  donorProfile    DonorProfile?
  hospitalProfile HospitalProfile?
  bloodRequests   BloodRequest[] // Requests made by this user
  donations       DonationRecord[] // Donations made by this user
  notifications   Notification[]

  auditLogs       AuditLog[]
  files           File[]          // Files uploaded by this user

  @@map("users")
}

// ... (existing models) ...

model File {
  id         String   @id @default(uuid())
  userId     String?  // Optional: Link to user who uploaded it
  name       String
  url        String   @unique
  size       Int      // In bytes
  type       String   // MIME type
  uploadedAt DateTime @default(now())

  user       User?    @relation(fields: [userId], references: [id])

  @@map("files")
}


model DonorProfile {
  id               String    @id @default(uuid())
  userId           String    @unique
  fullName         String
  bloodType        BloodType
  phone            String
  address          String?
  city             String?
  state            String?
  zipCode          String?
  lastDonationDate DateTime?
  isAvailable      Boolean   @default(true)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("donor_profiles")
}

model HospitalProfile {
  id            String  @id @default(uuid())
  userId        String  @unique
  name          String
  licenseNumber String  @unique // Important for verification
  phone         String
  address       String
  city          String
  state         String
  zipCode       String
  latitude      Float? // For location-based search
  longitude     Float?

  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  inventory BloodInventory[]
  requests  BloodRequest[] // Requests received/fulfilled by the hospital OR outgoing requests

  @@map("hospital_profiles")
}

model BloodInventory {
  id         String    @id @default(uuid())
  hospitalId String
  bloodType  BloodType
  quantity   Int // Number of units/bags
  expiryDate DateTime? // Optional: track batches
  updatedAt  DateTime  @updatedAt

  hospital HospitalProfile @relation(fields: [hospitalId], references: [id], onDelete: Cascade)

  // Indexes for faster searching
  @@index([hospitalId])
  @@index([bloodType])
  @@map("blood_inventory")
}

model BloodRequest {
  id           String        @id @default(uuid())
  requesterId  String // User who requested (Hospital, Donor, Admin)
  hospitalId   String? // Optional: Specific hospital targeted
  bloodType    BloodType
  quantity     Int
  status       RequestStatus @default(PENDING)
  urgency      UrgencyLevel  @default(MEDIUM)
  location     String? // Delivery location if different from profile
  neededByDate DateTime
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  requester User             @relation(fields: [requesterId], references: [id])
  hospital  HospitalProfile? @relation(fields: [hospitalId], references: [id]) // Fulfilled by/Targeted at

  @@index([status])
  @@index([bloodType])
  @@index([urgency])
  @@map("blood_requests")
}

model DonationRecord {
  id           String         @id @default(uuid())
  donorId      String
  hospitalId   String? // Where donation occurred (optional if drive)
  bloodType    BloodType
  quantity     Int // Units
  donationDate DateTime       @default(now())
  status       DonationStatus @default(COMPLETED)
  notes        String?

  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  donor User @relation(fields: [donorId], references: [id])

  @@index([donorId])
  @@index([donationDate])
  @@index([bloodType]) // Optimized for filtering by blood type
  @@index([createdAt]) // Optimized for date ranges
  @@map("donation_records")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  title     String
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  action    String // e.g., "LOGIN", "UPDATE_INVENTORY"
  details   String? // JSON or text details
  ipAddress String?
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}
